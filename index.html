<!doctype html>
<html lang="fi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Taidepeli ‚Äî Metamorfoosi + Snap + Liikkeen sointi</title>

<!-- p5.js + p5.sound -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/addons/p5.sound.min.js"></script>

<style>
  :root{ color-scheme: dark; --safe-bottom: env(safe-area-inset-bottom, 0px); }
  html, body { height: 100%; }
  body{ margin:0; background:#0e0e0e; color:#eee; font-family:system-ui, sans-serif; padding-bottom: var(--uih, 300px); }
  canvas{ display:block; margin:0 auto; outline:1px solid #1d1d1d; }

  /* Alapalkki: kuvanapit + S√§√§d√∂t */
  #controlBar{
    position:fixed; left:10px; right:10px;
    bottom:calc(10px + var(--safe-bottom));
    display:flex; flex-wrap:wrap; gap:8px; z-index:9999;
  }
  #controlBar button{
    background:#2ab78b; color:#fff; border:0; padding:6px 10px;
    border-radius:8px; cursor:pointer;
  }
  #controlBar button.active-image{ background:#178c68; box-shadow:0 0 8px rgba(42,183,139,.5); }

  /* UI-paneeli alareunaan, oma scrolli */
  #ui{
    position:fixed; left:10px; right:10px;
    bottom:calc(60px + var(--safe-bottom)); /* controlBarin yl√§puolelle */
    z-index:9998; background:rgba(10,10,10,.92); backdrop-filter: blur(6px);
    border-top:1px solid #2ab78b33; padding:10px; border-radius:12px;
    display:flex; flex-wrap:wrap; gap:8px;
    max-height:clamp(260px, 60vh, 520px);
    overflow:auto; -webkit-overflow-scrolling:touch;
  }

  .hint{ opacity:.85 }
  .pill{ cursor:pointer; user-select:none; }

  /* S√§√§dinruudukot */
  .ui-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:10px; width:100%; }
  .ui-grid.tight{ grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
  #ui label{
    display:flex; flex-direction:column; gap:6px;
    background:#151515; padding:8px 10px; border-radius:10px;
  }
  #ui input[type="range"]{ width:100%; touch-action:none; }
  #ui .checkbox-row{ flex-direction:row; align-items:center; gap:10px; }

  /* Lis√§asetukset (details) */
  #advSettings{
    width:100%; background:#121212; border:1px solid #1f1f1f; border-radius:12px; padding:6px 8px;
  }
  #advSettings > summary{ cursor:pointer; user-select:none; list-style:none; font-weight:600; padding:4px 6px 8px 2px; }
  #advSettings summary::-webkit-details-marker{ display:none; }
  #advSettings .ui-grid{ display:none; }
  #advSettings[open] .ui-grid{ display:grid; }
  @media (max-width:768px){
    #advSettings .ui-grid{ display:grid !important; }
    .ui-grid{ grid-template-columns:1fr; gap:8px; }
  }

  /* Toimintonapit */
  #ui .primary{
    background:#2ab78b; color:#fff; border:0; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600;
  }

  /* √Ñ√§nen k√§ynnistysnappi */
  #startAudio{
    position:fixed; inset:50% auto auto 50%; transform:translate(-50%,-50%);
    font-size:16px; padding:10px 16px; border-radius:12px; background:#2ab78b; color:#fff;
    border:none; cursor:pointer; z-index:9999;
  }

  /* AINA n√§kyv√§ kirjainnappirivi ‚Äì sijoitus dynaamisesti JS:ll√§ */
  #kbDock{
    position: fixed;
    left: 10px; right: 10px;
    bottom: 120px;                 /* fallback ‚Äì JS laskee tarkan */
    display: flex; flex-wrap: wrap; gap: 10px;
    justify-content: center;
    z-index: 10001;
  }
  #kbDock button{
    min-width: 42px; height: 42px; border-radius: 12px;
    background:#2ab78b; color:#fff; border:0; font-weight:700; cursor:pointer;
  }
  @media (max-width:768px){
    #kbDock button{ min-width:38px; height:38px; border-radius:10px; }
  }
</style>
</head>
<body>

<!-- AINA N√ÑKYV√Ñ kirjainnappirivi (delegoi klikkaukset ‚Äúvirtuaalinapeille‚Äù) -->
<div id="kbDock">
  <button data-kb="#kbE">E</button>
  <button data-kb="#kbO">O</button>
  <button data-kb="#kbExplode">üí•</button>
  <button data-kb="#kbP">P</button>
  <button data-kb="#kbJ">J</button>
</div>

<!-- Alapalkki: oletuskuvat + S√§√§d√∂t -->
<div id="controlBar">
  <button id="btnSuojaani">Suojaani</button>
  <button id="btnRed">Redgrid</button>
  <button id="btnGreen">Greengrid</button>
  <button id="btnBlack">Blackgrid</button>
  <button id="toggleUI">S√§√§d√∂t piiloon</button>
</div>

<button id="startAudio">‚ñ∂ K√§ynnist√§ √§√§ni</button>
<button id="toggleSound" style="
  position:fixed;top:15px;right:15px;
  font-size:14px;padding:6px 10px;border-radius:10px;
  background:#151515;color:#fff;border:1px solid #2ab78b;
  cursor:pointer;display:none;z-index:9999;">
  üîä √Ñ√§ni p√§√§ll√§
</button>

<!-- UI-paneeli -->
<div id="ui">
  <div class="hint">E = Edit/Play ‚Ä¢ O = Ghost ‚Ä¢ Klikkaa tyhj√§√§ r√§j√§ytt√§√§/kokoaa</div>

  <input type="file" id="picker" accept="image/*" />

  <div class="ui-grid">
    <label>Palojen m√§√§r√§
      <input type="range" id="pieces" min="60" max="500" value="220">
    </label>
    <label>Metamorfoosi
      <input type="range" id="morph" min="0" max="1" step="0.01" value="0.55">
    </label>
    <label>Paletti
      <input type="range" id="palette" min="0" max="2" step="0.01" value="1.0">
    </label>
  </div>

  <details id="advSettings">
    <summary>Lis√§asetukset ‚ñæ</summary>
    <div class="ui-grid tight">
      <label>Kasaantuminen
        <input type="range" id="cohere" min="0" max="1" step="0.01" value="0.10">
      </label>
      <label>Hajotus
        <input type="range" id="explode" min="0" max="500" value="260">
      </label>
      <label>Turbulenssi
        <input type="range" id="turb" min="0" max="2" step="0.01" value="0.6">
      </label>
      <label>Snap-et√§isyys
        <input type="range" id="snapRange" min="4" max="80" value="28">
      </label>
      <label class="checkbox-row">
        <input type="checkbox" id="snapOn" checked>
        <span>Snap p√§√§ll√§</span>
      </label>
      <button id="reshuffle" type="button" class="primary">Arvo palat</button>
    </div>
  </details>

  <div class="pill" id="toggleMode">‚ñ∂ Play</div>
</div>

<script>
/* ------------------ Tila ------------------ */
let srcImg, gfx;
let tiles = [];
let exploding = true;
let editMode = true;
let showGhost = false;
let seed = Math.floor(Math.random()*1e9);
let dragging = null, dragOff;

const ui = id => document.getElementById(id);
const P  = () => ui('pieces').value|0;

/* ------------------ √Ñ√§ni ------------------ */
let audioStarted = false, soundOn = false;
let osc, filter, reverb;

async function startAudio() {
  try { userStartAudio(); } catch(e) {}
  osc    = new p5.Oscillator('sine');
  filter = new p5.LowPass();
  reverb = new p5.Reverb();
  osc.disconnect(); osc.connect(filter); filter.connect(reverb); reverb.process(filter, 3, 2);
  osc.start(); osc.amp(0.12, 0.6);
  audioStarted = true; soundOn = true;
  ui('startAudio').style.display = 'none';

  const soundBtn = document.getElementById('toggleSound');
  soundBtn.style.display = 'block';
  soundBtn.textContent = 'üîä √Ñ√§ni p√§√§ll√§';
  soundBtn.onclick = () => {
    if (!audioStarted || !osc) return;
    soundOn = !soundOn;
    if (soundOn) { osc.amp(0.12, 0.4); soundBtn.textContent = 'üîä √Ñ√§ni p√§√§ll√§'; }
    else { osc.amp(0.0, 0.4); soundBtn.textContent = 'üîá √Ñ√§ni pois'; }
  };
}
ui('startAudio').addEventListener('click', startAudio);

/* ------------------ Kuvav√§limuisti ------------------ */
const cache = {};
function preload(){
  ['hopeavuori_maija suojaani.png','hopeavuori_maija_redgrid.jpg','hopeavuori_maija_greengrid.jpg','hopeavuori_maija_blackgrid.jpg']
    .forEach(path => loadImage(path, img => cache[path] = img));
}
function useDefault(path){
  if (cache[path]) { setSourceImage(cache[path]); return; }
  loadImage(path, img => setSourceImage(img), err => { console.error('Kuvan lataus ep√§onnistui:', path, err); alert('Kuvaa ei l√∂ytynyt: ' + path); });
}

/* ------------------ Layout-apurit ------------------ */
function viewH(){ return (window.visualViewport ? window.visualViewport.height : window.innerHeight); }
function isVisible(el){ if(!el) return false; const disp = el.style.display || getComputedStyle(el).display; return disp !== 'none'; }

function sizeCanvasToWindow(){
  const bar   = document.getElementById('controlBar');
  const uiEl  = document.getElementById('ui');

  const barH  = (bar?.offsetHeight || 0) + 16;
  const uiH   = isVisible(uiEl) ? Math.min(uiEl.offsetHeight, Math.round(viewH()*0.5)) : 0;
  const reserve = barH + uiH + 12;

  const newW = window.innerWidth;
  const newH = Math.max(220, viewH() - reserve);

  // Siirr√§ paloja suhteessa keskikohtaan, jotta ne eiv√§t karkaa
  const oldW = (typeof width === 'number') ? width : newW;
  const oldH = (typeof height === 'number') ? height : newH;
  const dx = (newW - oldW) * 0.5;
  const dy = (newH - oldH) * 0.5;

  if (tiles && tiles.length){
    for (const t of tiles){
      t.pos.x += dx; t.pos.y += dy;
      t.home.x += dx; t.home.y += dy;
    }
  }

  resizeCanvas(newW, newH, true);
  if (srcImg) fitImageToCanvas();

  // P√§ivit√§ dynaaminen alatyhj√§ bodylle
  document.documentElement.style.setProperty('--uih', (uiEl ? uiEl.offsetHeight + 16 : 316) + 'px');

  // P√§ivit√§ napparivit
  layoutBars();
}

/* kirjainnappien ankkurointi controlBarin yl√§puolelle */
function layoutBars(){
  const bar = document.getElementById('controlBar');
  const kb  = document.getElementById('kbDock');
  if(!kb) return;
  const safe = parseInt(getComputedStyle(document.documentElement)
               .getPropertyValue('--safe-bottom')) || 0;
  const barH = (bar?.offsetHeight || 0) + 10 + safe; // bar + v√§li + safe
  kb.style.bottom = (barH + 8) + 'px';               // juuri barin yl√§puolelle
}

['load','resize','orientationchange','pageshow'].forEach(ev=>{
  window.addEventListener(ev, ()=>{ clearTimeout(window.__vh); window.__vh=setTimeout(()=>{ sizeCanvasToWindow(); layoutBars(); }, 120); });
});
if (window.visualViewport){
  visualViewport.addEventListener('resize', ()=>{ clearTimeout(window.__vv); window.__vv=setTimeout(()=>{ sizeCanvasToWindow(); layoutBars(); }, 120); });
  visualViewport.addEventListener('scroll', ()=>{ clearTimeout(window.__vv2); window.__vv2=setTimeout(layoutBars, 120); });
}

/* ------------------ P5 elinkaari ------------------ */
function setup(){
  createCanvas(Math.min(window.innerWidth, 1200), Math.min(window.innerHeight-96, 820));
  background(14); fill(230); noStroke(); textAlign(CENTER,CENTER); textSize(16);
  text('Ved√§ ja pudota kuva t√§h√§n (tai k√§yt√§ Valitse kuva)', width/2, height/2);

  const cnv = document.querySelector('canvas');
  cnv.addEventListener('dragover', e=>e.preventDefault());
  cnv.addEventListener('drop', e=>{ e.preventDefault(); if(e.dataTransfer.files.length) loadFromFile(e.dataTransfer.files[0]); });
  ui('picker').addEventListener('change', e=>{ if(e.target.files.length) loadFromFile(e.target.files[0]); });

  ui('reshuffle').onclick = ()=>{ if(srcImg) makeTiles(); };
  ui('toggleMode').onclick = ()=>toggleMode();

  // AINA N√ÑKYV√Ñ KB-dock: delegoi ‚Äúvirtuaalinapeille‚Äù
  document.getElementById('kbDock')?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-kb]');
    if(!btn) return;
    const target = document.querySelector(btn.getAttribute('data-kb'));
    target?.click();
  });

  // Kuvanapit
  [
    { id:'btnSuojaani', path:'hopeavuori_maija suojaani.png' },
    { id:'btnRed',      path:'hopeavuori_maija_redgrid.jpg' },
    { id:'btnGreen',    path:'hopeavuori_maija_greengrid.jpg' },
    { id:'btnBlack',    path:'hopeavuori_maija_blackgrid.jpg' }
  ].forEach(({ id, path }) => {
    const b = document.getElementById(id); if(!b) return;
    b.addEventListener('mousedown', () => b.blur());
    b.addEventListener('touchstart', () => b.blur());
    b.addEventListener('click', () => { useDefault(path); highlightButton(id); layoutBars(); });
  });

  // S√§√§d√∂t-napin toggle + keskityksen s√§ilytys + napin teksti
  const toggleBtn = document.getElementById('toggleUI');
  function updateToggleUIButton(){
    const panel = document.getElementById('ui');
    const visible = getComputedStyle(panel).display !== 'none';
    toggleBtn.textContent = visible ? 'S√§√§d√∂t piiloon' : 'S√§√§d√∂t esiin';
  }
  toggleBtn?.addEventListener('click', () => {
    const panel = document.getElementById('ui');
    const wasVisible = getComputedStyle(panel).display !== 'none';

    const oldW = width, oldH = height;
    panel.style.display = wasVisible ? 'none' : 'flex';
    sizeCanvasToWindow();

    const newW = width, newH = height;
    const dx = (newW - oldW) * 0.5;
    const dy = (newH - oldH) * 0.5;
    if (tiles && tiles.length){
      for (const t of tiles){ t.pos.x += dx; t.pos.y += dy; t.home.x += dx; t.home.y += dy; }
    }
    updateToggleUIButton();
    layoutBars();
  });
  updateToggleUIButton();

  /* Virtuaalinapit kbDockille */
  const mk = (id, fn) => { const b=document.createElement('button'); b.id=id; b.style.display='none'; b.onclick=fn; document.body.appendChild(b); };
  mk('kbE', ()=> ui('toggleMode').click());
  mk('kbO', ()=> { showGhost = !showGhost; });
  mk('kbP', savePNG);
  mk('kbJ', saveJPG);
  mk('kbExplode', () => { exploding = !exploding; if (exploding) burstImpulse(); else calmImpulse(); });

  sizeCanvasToWindow();
  layoutBars();
}
function windowResized(){ sizeCanvasToWindow(); layoutBars(); }

function loadFromFile(file){
  const reader = new FileReader();
  reader.onload = ev => loadImage(ev.target.result, img=>{ srcImg = img; fitImageToCanvas(); makeTiles(); });
  reader.readAsDataURL(file);
}
function fitImageToCanvas(){
  gfx = createGraphics(width, height);
  gfx.clear();
  const s = Math.min(width/srcImg.width, height/srcImg.height);
  const iw = srcImg.width*s, ih = srcImg.height*s;
  const ix = (width-iw)/2, iy = (height-ih)/2;
  gfx.image(srcImg, ix, iy, iw, ih);
}

/* ------------------ Palat ------------------ */
function sampleHue(g, x, y){
  const c = g.get(Math.floor(x), Math.floor(y));
  colorMode(RGB); const col = color(c[0],c[1],c[2]);
  colorMode(HSB); const h = hue(col), s = saturation(col), b = brightness(col);
  colorMode(RGB); return {h,s,b};
}
function makeTiles(){
  randomSeed(seed = Math.floor(Math.random()*1e9)); noiseSeed(seed);
  tiles.length = 0;

  const n = P();
  const cols = Math.floor(Math.sqrt(n)*1.5);
  const rows = Math.floor(n/cols);
  const gw = width/cols, gh = height/rows;

  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      if(tiles.length>=n) break;
      const cx = (x+0.5)*gw + random(-gw*0.2, gw*0.2);
      const cy = (y+0.5)*gh + random(-gh*0.2, gh*0.2);
      const w = gw*random(0.7,1.2), h = gh*random(0.7,1.2);
      const sx = constrain(cx-w/2,0,width-1), sy = constrain(cy-h/2,0,height-1);
      const sw = constrain(w,4,width-sx), sh = constrain(h,4,height-sy);
      const g = createGraphics(sw, sh); g.image(gfx, -sx, -sy);

      const hueSamp = sampleHue(gfx, sx+sw/2, sy+sh/2);
      tiles.push({
        img:g, hue:hueSamp.h, sat:hueSamp.s, bri:hueSamp.b,
        home:createVector(cx,cy),
        pos:createVector(cx + random(-40,40), cy + random(-40,40)),
        vel:p5.Vector.random2D().mult(random(0.5,2)),
        ang:random(TWO_PI), avel:random(-0.06,0.06),
        size:createVector(sw,sh), scale:1, alpha:255,
        shear:createVector(random(-0.12,0.12), random(-0.12,0.12))
      });
    }
  }
}

/* ------------------ Vuorovaikutus ------------------ */
function toggleMode(){ editMode = !editMode; ui('toggleMode').textContent = editMode ? '‚ñ∂ Play' : '‚ñ† Edit'; }
function pointInTile(t, x, y){ const w = t.size.x*t.scale, h = t.size.y*t.scale; return (x>t.pos.x-w/2 && x<t.pos.x+w/2 && y>t.pos.y-h/2 && y<t.pos.y+h/2); }

function mousePressed(){
  if(!srcImg) return;
  let any = false;
  for(let i=tiles.length-1; i>=0; i--){
    const t = tiles[i];
    if(pointInTile(t, mouseX, mouseY)){
      any = true;
      if(editMode){
        dragging = t; dragOff = createVector(mouseX - t.pos.x, mouseY - t.pos.y);
        tiles.push(tiles.splice(i,1)[0]); // p√§√§llimm√§iseksi
      }
      break;
    }
  }
  if(!any) exploding = !exploding;
}
function mouseDragged(){ if(dragging){ dragging.pos.set(mouseX - dragOff.x, mouseY - dragOff.y); dragging.vel.mult(0); } }
function mouseReleased(){ if(dragging){ if(ui('snapOn').checked) snapTile(dragging); dragging = null; } }

function keyPressed(){
  if(key==='e'||key==='E') toggleMode();
  if(key==='o'||key==='O') { showGhost = !showGhost; }
  if(key==='p'||key==='P') savePNG();
  if(key==='j'||key==='J') saveJPG();
}

/* Snap */
function snapTile(t){
  const R = +ui('snapRange').value;
  const w1 = t.size.x*t.scale, h1 = t.size.y*t.scale;
  let best = null, bestDist = Infinity;
  for(const o of tiles){
    if(o===t) continue;
    const w2 = o.size.x*o.scale, h2 = o.size.y*o.scale;
    const dx = t.pos.x - o.pos.x, dy = t.pos.y - o.pos.y;
    const targetX = (w1+w2)/2, targetY = (h1+h2)/2;

    if(Math.abs(dy) < (h1+h2)/2 * 0.35){
      const gapR = Math.abs(dx - targetX), gapL = Math.abs(dx + targetX);
      if(gapR <= R && gapR < bestDist){ bestDist = gapR; best = {x:o.pos.x + targetX, y:o.pos.y}; }
      if(gapL <= R && gapL < bestDist){ bestDist = gapL; best = {x:o.pos.x - targetX, y:o.pos.y}; }
    }
    if(Math.abs(dx) < (w1+w2)/2 * 0.35){
      const gapB = Math.abs(dy - targetY), gapT = Math.abs(dy + targetY);
      if(gapB <= R && gapB < bestDist){ bestDist = gapB; best = {x:o.pos.x, y:o.pos.y + targetY}; }
      if(gapT <= R && gapT < bestDist){ bestDist = gapT; best = {x:o.pos.x, y:o.pos.y - targetY}; }
    }
  }
  if(best){ t.pos.x = lerp(t.pos.x, best.x, 0.9); t.pos.y = lerp(t.pos.y, best.y, 0.9); t.vel.mult(0); }
}

/* ------------------ Piirto + √§√§ni ------------------ */
function draw(){
  background(14);
  if(!srcImg) return;

  if(showGhost){ push(); tint(255,40); image(gfx, 0, 0); pop(); }

  const morph   = +ui('morph').value;
  const palette = +ui('palette').value;
  const cohere  = +ui('cohere').value;
  const explode = +ui('explode').value;
  const turb    = +ui('turb').value;

  const warmSpot    = createVector(width*0.72, height*0.35);
  const coolSpot    = createVector(width*0.28, height*0.65);
  const neutralSpot = createVector(width*0.5,  height*0.5);

  let totalSpeed = 0;

  for(const t of tiles){
    const sc = 0.0018;
    const theta = noise(t.pos.x*sc, t.pos.y*sc, frameCount*0.01)*TWO_PI*2;
    const flow = p5.Vector.fromAngle(theta).mult(1.1*turb);

    const homeDir = p5.Vector.sub(t.home, t.pos);
    const away    = homeDir.copy().mult(-1).setMag(explode*0.02);
    const target  = exploding ? p5.Vector.add(t.home, away) : t.home.copy();
    const steer   = p5.Vector.sub(target, t.pos).mult(cohere*(editMode?0.25:1));

    let grav = createVector(0,0);
    const h = t.hue;
    if(palette>0){
      let attractor;
      if((h>=20 && h<=70) || (h>=330 || h<20)) attractor = warmSpot;
      else if(h>=170 && h<=260) attractor = coolSpot;
      else attractor = neutralSpot;
      grav = p5.Vector.sub(attractor, t.pos).setMag(0.12*palette);
    }

    const time = frameCount*0.02 + t.home.x*0.001 + t.home.y*0.001;
    const breath = 1 + (sin(time)*0.25 + 0.25) * morph;
    t.scale = lerp(t.scale, breath, 0.15);
    t.alpha = lerp(t.alpha, 255 - 90*morph*(1-noise(time)), 0.1);
    const shearAmt = 0.15*morph;
    t.shear.x = lerp(t.shear.x, map(noise(time, 1),0,1,-shearAmt,shearAmt), 0.2);
    t.shear.y = lerp(t.shear.y, map(noise(time, 2),0,1,-shearAmt,shearAmt), 0.2);

    if(!editMode && dragging!==t){ t.vel.add(flow).add(grav).add(steer); }
    t.vel.limit(6 + morph*2);
    t.pos.add(t.vel);
    t.ang += t.avel*(0.6 + morph*0.8) + t.vel.mag()*0.01;

    if(t.pos.x<-60) t.pos.x=width+60;
    if(t.pos.x>width+60) t.pos.x=-60;
    if(t.pos.y<-60) t.pos.y=height+60;
    if(t.pos.y>height+60) t.pos.y=-60;

    totalSpeed += t.vel.mag();

    push();
    translate(t.pos.x, t.pos.y);
    rotate(t.ang*0.25);
    shearX(t.shear.x); shearY(t.shear.y);
    imageMode(CENTER);
    tint(255, t.alpha);
    image(t.img, 0, 0, t.size.x*t.scale, t.size.y*t.scale);
    pop();
  }

  if (audioStarted && osc) {
    const avgSpeed = totalSpeed / max(1, tiles.length);
    const freq = map(avgSpeed, 0, 8, 140, 880, true);
    const vol  = soundOn ? map(avgSpeed, 0, 6, 0.05, 0.28, true) : 0.0;
    const cut  = map(avgSpeed, 0, 6, 300, 5000, true);
    osc.freq(freq, 0.2); osc.amp(vol, 0.4); filter.freq(cut);
  }
}

/* ------------------ Tallennukset ------------------ */
function savePNG(){
  const stamp = new Date().toISOString().slice(0,19).replace(/[T:]/g,'-');
  saveCanvas('echoform-'+stamp, 'png');
}
function saveJPG(){
  const c = document.querySelector('canvas'); if(!c) return;
  const a = document.createElement('a');
  a.href = c.toDataURL('image/jpeg', 0.92); a.download = 'taide.jpg';
  document.body.appendChild(a); a.click(); a.remove();
}

/* ------------------ Kuvan asetus ------------------ */
function setSourceImage(img){ srcImg = img; fitImageToCanvas(); makeTiles(); }

/* ------------------ Lis√§asetukset mobiilissa auki + padding p√§ivitys ------------------ */
(function(){
  const adv = document.getElementById('advSettings');
  const panel  = document.getElementById('ui');
  function syncDetails(){ if (adv && window.innerWidth <= 768) adv.setAttribute('open',''); }
  function updatePadding(){ document.documentElement.style.setProperty('--uih', (panel ? panel.offsetHeight + 16 : 316) + 'px'); }
  syncDetails(); updatePadding();
  window.addEventListener('resize', () => { syncDetails(); requestAnimationFrame(updatePadding); });
  adv?.addEventListener('toggle', () => requestAnimationFrame(updatePadding));
})();

/* ------------------ Napit korostus ------------------ */
function highlightButton(btnId){
  document.querySelectorAll('#controlBar button').forEach(b => b.classList.remove('active-image'));
  const el = document.getElementById(btnId); if(el) el.classList.add('active-image');
}

/* ------------------ R√§j√§hdysimpulssit ------------------ */
function burstImpulse(){
  const explodeVal = +ui('explode').value || 260;
  const power = 0.06 * (explodeVal / 260);
  for (const t of tiles){
    const dir = p5.Vector.sub(t.pos, t.home).normalize();
    if (!isFinite(dir.x) || !isFinite(dir.y)) dir.set(1,0);
    const jitter = p5.Vector.random2D().mult(0.6);
    t.vel.add(dir.mult(12 * power)).add(jitter);
  }
}
function calmImpulse(){ for (const t of tiles){ t.vel.mult(0.35); } }
</script>
</body>
</html>

